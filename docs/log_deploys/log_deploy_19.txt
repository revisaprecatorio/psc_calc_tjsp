âš ï¸ OBSERVAÃ‡ÃƒO IMPORTANTE SOBRE O SISTEMA OPERACIONAL:
VocÃª tem razÃ£o em questionar! Vamos esclarecer:

Ambiente Atual:
VPS Host: Ubuntu (srv987902)
Container Docker: Debian Bookworm (python:3.12-slim-bookworm)
Por Que Isso Importa:
dockerfile
# Dockerfile - Linha 2
FROM python:3.12-slim-bookworm
O container NÃƒO usa Ubuntu, usa Debian Bookworm! Isso significa:

âœ… Todas as tentativas foram corretas para Debian
âœ… Google Chrome foi instalado do repositÃ³rio Debian
âŒ Mas o problema persiste mesmo assim
Alternativa: Usar Imagem Base Ubuntu
Podemos tentar trocar a imagem base para Ubuntu

---- 



dockerfile
# OPÃ‡ÃƒO 1: Ubuntu 22.04
FROM ubuntu:22.04

# OPÃ‡ÃƒO 2: Python oficial com Ubuntu (nÃ£o existe oficialmente)
# TerÃ­amos que instalar Python manualmente

# OPÃ‡ÃƒO 3: Imagem nÃ£o-oficial Python + Ubuntu
FROM python:3.12-slim  # Usa Debian por padrÃ£o
ğŸ¯ PrÃ³ximos Passos Quando Retomar:
OpÃ§Ã£o A: Selenium Grid (Mais Simples)
Container separado com Chrome prÃ©-configurado
Selenium oficial jÃ¡ resolve problemas de ambiente
Recomendado para evitar mais debugging
OpÃ§Ã£o B: Trocar Imagem Base para Ubuntu
Testar se problema Ã© especÃ­fico do Debian
Mais trabalhoso (precisa instalar Python)
OpÃ§Ã£o C: Playwright
Biblioteca mais moderna
Melhor suporte para Docker/headless
Requer reescrever cÃ³digo do crawler
Por enquanto, tudo documentado e versionado no Git!

Quando vocÃª quiser retomar, me avise qual caminho prefere seguir. ğŸš€

--- 

ğŸ“‹ RESUMO DO PROBLEMA:
Erro Persistente:
SessionNotCreatedException: user data directory is already in use
Tentativas Realizadas (TODAS FALHARAM):
âŒ DiretÃ³rio Ãºnico por execuÃ§Ã£o
âŒ Remover --user-data-dir do orchestrator
âŒ Criar temp dir Ãºnico no crawler
âŒ Matar processos Chrome antes de executar
âŒ Remover completamente --user-data-dir
âŒ Adicionar 12 flags para desabilitar cache
âŒ Substituir Chromium por Google Chrome oficial
âŒ Limpeza de processos
âŒ Flags agressivas
âŒ DiretÃ³rio temporÃ¡rio com timestamp
âŒ Comentar cÃ³digo user-data-dir
âŒ Google Chrome 141.0.7390.54-1
ObservaÃ§Ãµes CrÃ­ticas:
â±ï¸ Erro acontece em 0.7 segundos (antes de qualquer navegaÃ§Ã£o)
ğŸ› Problema Ã© fundamental com Selenium/ChromeDriver no Docker
ğŸ–¥ï¸ Container usa Debian Bookworm, nÃ£o Ubuntu
âœ… Worker e Orchestrator funcionam perfeitamente
âŒ Apenas Selenium/Chrome falha
ğŸ¯ PRÃ“XIMOS PASSOS (Quando Retomar):
RECOMENDAÃ‡ÃƒO: OpÃ§Ã£o A - Selenium Grid
Por quÃª?

âœ… SoluÃ§Ã£o mais rÃ¡pida e confiÃ¡vel
âœ… Chrome jÃ¡ configurado pelo Selenium oficial
âœ… NÃ£o requer mudanÃ§as no cÃ³digo
âœ… Resolve problemas de ambiente automaticamente
Como implementar:

yaml
# docker-compose.yml
services:
  selenium-chrome:
    image: selenium/standalone-chrome:latest
    ports:
      - "4444:4444"
    shm_size: 2gb
    
  worker:
    depends_on:
      - selenium-chrome
    environment:
      - SELENIUM_REMOTE_URL=http://selenium-chrome:4444
ğŸ“Š Status Atual:
âœ… CÃ³digo versionado no Git
âœ… DocumentaÃ§Ã£o completa
âœ… 19 logs de deploy
âœ… Worker funcional
âœ… Orchestrator funcional
âŒ Selenium/Chrome bloqueado
â¸

--- 

ğŸ¯ PLANO COMPLETO: IMPLEMENTAÃ‡ÃƒO SELENIUM GRID
ğŸ“‹ CONTEXTO IMPORTANTE
Esclarecimento sobre Sistema Operacional:
VocÃª estÃ¡ CORRETO sobre a VPS ser Ubuntu, mas hÃ¡ uma nuance importante:

VPS Host: Ubuntu (srv987902) âœ…
Container Docker: Debian Bookworm (python:3.12-slim-bookworm) âš ï¸
O problema estÃ¡ DENTRO do container, que usa Debian, nÃ£o Ubuntu. Quando rodamos Docker, o container tem seu prÃ³prio sistema operacional isolado.

Por Que Selenium Grid Resolve?
O Selenium Grid usa um container separado que jÃ¡ vem com:

âœ… Chrome prÃ©-instalado e configurado
âœ… ChromeDriver compatÃ­vel
âœ… Todas as dependÃªncias resolvidas
âœ… Ambiente testado pelo time do Selenium
NÃ£o importa se o host Ã© Ubuntu ou Debian - o Selenium Grid jÃ¡ funciona!

ğŸ—ï¸ ARQUITETURA ATUAL vs NOVA
Arquitetura Atual (COM PROBLEMA):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Container: tjsp_worker_1           â”‚
â”‚  (Debian Bookworm)                  â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ orchestrator_subprocess.py   â”‚  â”‚
â”‚  â”‚         â†“                    â”‚  â”‚
â”‚  â”‚ crawler_full.py              â”‚  â”‚
â”‚  â”‚         â†“                    â”‚  â”‚
â”‚  â”‚ Selenium WebDriver           â”‚  â”‚
â”‚  â”‚         â†“                    â”‚  â”‚
â”‚  â”‚ Google Chrome âŒ FALHA       â”‚  â”‚
â”‚  â”‚ (SessionNotCreated)          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Problema: Chrome dentro do container nÃ£o consegue iniciar sessÃ£o.

Arquitetura Nova (COM SELENIUM GRID):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Container: tjsp_worker_1     â”‚    â”‚ Container: selenium-chrome  â”‚
â”‚ (Debian Bookworm)            â”‚    â”‚ (Ubuntu + Chrome oficial)   â”‚
â”‚                              â”‚    â”‚                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ orchestrator_subprocessâ”‚  â”‚    â”‚ â”‚ Selenium Grid Hub       â”‚ â”‚
â”‚ â”‚         â†“              â”‚  â”‚    â”‚ â”‚         â†“               â”‚ â”‚
â”‚ â”‚ crawler_full.py        â”‚  â”‚    â”‚ â”‚ Chrome + ChromeDriver   â”‚ â”‚
â”‚ â”‚         â†“              â”‚  â”‚    â”‚ â”‚ (PrÃ©-configurado âœ…)    â”‚ â”‚
â”‚ â”‚ Remote WebDriver â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”€â”€â”¼â†’â”‚ Executa comandos        â”‚ â”‚
â”‚ â”‚ (HTTP: 4444)           â”‚  â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ (volumes)
    downloads/ screenshots/
Vantagens:

âœ… Chrome roda em container separado e otimizado
âœ… Worker nÃ£o precisa instalar Chrome
âœ… ComunicaÃ§Ã£o via HTTP (Remote WebDriver)
âœ… Problema de "user-data-dir" nÃ£o existe no Selenium Grid
ğŸ”§ MUDANÃ‡AS NECESSÃRIAS
1. docker-compose.yml (Adicionar Selenium Grid)
yaml
version: "3.9"

services:
  # NOVO: Container Selenium Grid com Chrome
  selenium-chrome:
    image: selenium/standalone-chrome:latest
    container_name: selenium_chrome
    ports:
      - "4444:4444"  # Porta do Selenium Grid
      - "7900:7900"  # Porta do VNC (opcional, para debug visual)
    shm_size: '2gb'  # Essencial para Chrome nÃ£o travar
    restart: unless-stopped
    environment:
      - SE_NODE_MAX_SESSIONS=5
      - SE_NODE_SESSION_TIMEOUT=300
      - SE_NODE_OVERRIDE_MAX_SESSIONS=true

  # MODIFICADO: Worker agora se conecta ao Selenium Grid
  worker:
    build: .
    image: tjsp-worker:latest
    container_name: tjsp_worker_1
    depends_on:
      - selenium-chrome  # Aguarda Selenium Grid iniciar
    env_file:
      - .env
    environment:
      # NOVO: URL do Selenium Grid
      - SELENIUM_REMOTE_URL=http://selenium-chrome:4444
    volumes:
      - ./downloads:/app/downloads
      - ./screenshots:/app/screenshots
      # REMOVIDO: chrome_profile (nÃ£o precisa mais)
      - ./certs:/app/certs
    restart: unless-stopped
MudanÃ§as:

âœ… Adiciona serviÃ§o selenium-chrome
âœ… Worker depende do Selenium Grid
âœ… VariÃ¡vel SELENIUM_REMOTE_URL para conexÃ£o
âœ… Remove volume chrome_profile (nÃ£o precisa mais)
2. crawler_full.py (Usar Remote WebDriver)
Modificar a funÃ§Ã£o make_chrome():

python
def make_chrome(
    download_dir="downloads",
    user_data_dir=None,  # Ignorado no Remote WebDriver
    headless=True,
    cert_issuer_cn=None,
    cert_subject_cn=None,
    debugger_address=None,
    attach=False
):
    """
    Cria Chrome via Selenium Grid (Remote WebDriver) ou local (fallback)
    """
    import os as _os
    
    # Verifica se deve usar Selenium Grid
    selenium_remote_url = _os.environ.get("SELENIUM_REMOTE_URL")
    
    def make_options():
        opts = Options()
        
        # Headless (sempre True no Grid)
        if headless:
            try: opts.add_argument("--headless=new")
            except: opts.add_argument("--headless")
        
        # Flags essenciais
        opts.add_argument("--disable-gpu")
        opts.add_argument("--disable-dev-shm-usage")
        opts.add_argument("--no-sandbox")
        opts.add_argument("--window-size=1920,1080")
        opts.add_argument("--disable-blink-features=AutomationControlled")
        
        # PreferÃªncias de download
        Path(download_dir).mkdir(parents=True, exist_ok=True)
        prefs = {
            "download.default_directory": str(Path(download_dir).resolve()),
            "download.prompt_for_download": False,
            "download.directory_upgrade": True,
            "safebrowsing.enabled": True,
            "plugins.always_open_pdf_externally": True,
        }
        opts.add_experimental_option("prefs", prefs)
        
        # Auto-seleÃ§Ã£o de certificado
        if cert_issuer_cn or cert_subject_cn:
            policy = {"pattern": "https://esaj.tjsp.jus.br", "filter": {}}
            if cert_issuer_cn:
                policy["filter"].setdefault("ISSUER", {})["CN"] = cert_issuer_cn
            if cert_subject_cn:
                policy["filter"].setdefault("SUBJECT", {})["CN"] = cert_subject_cn
            opts.add_argument("--auto-select-certificate-for-urls=" + json.dumps([policy]))
        
        return opts
    
    opts = make_options()
    
    # NOVO: Usa Remote WebDriver se SELENIUM_REMOTE_URL estiver definido
    if selenium_remote_url:
        print(f"[INFO] Conectando ao Selenium Grid: {selenium_remote_url}")
        try:
            from selenium.webdriver import Remote
            driver = Remote(
                command_executor=selenium_remote_url,
                options=opts
            )
            driver.set_page_load_timeout(60)
            print("[INFO] Conectado ao Selenium Grid com sucesso!")
            return driver
        except Exception as e:
            print(f"[ERROR] Falha ao conectar no Selenium Grid: {e}")
            print("[INFO] Tentando Chrome local como fallback...")
    
    # Fallback: Chrome local (para desenvolvimento)
    print("[INFO] Usando Chrome local")
    driver = webdriver.Chrome(options=opts)
    driver.set_page_load_timeout(60)
    return driver
MudanÃ§as:

âœ… Detecta SELENIUM_REMOTE_URL do ambiente
âœ… Usa Remote() para conectar ao Grid
âœ… MantÃ©m fallback para Chrome local (dev)
âœ… Remove lÃ³gica de user_data_dir (nÃ£o precisa mais)
âœ… Remove flags desnecessÃ¡rias (Grid jÃ¡ otimizado)
3. Dockerfile (Simplificar - Remover Chrome)
dockerfile
# Dockerfile para rodar o WORKER (orchestrator_subprocess.py)
FROM python:3.12-slim-bookworm

ENV DEBIAN_FRONTEND=noninteractive \
    PIP_NO_CACHE_DIR=1 \
    TZ=America/Sao_Paulo

# SIMPLIFICADO: NÃ£o precisa mais instalar Chrome!
# Apenas dependÃªncias bÃ¡sicas
RUN apt-get update && apt-get install -y --no-install-recommends \
    wget ca-certificates \
  && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Instala dependÃªncias python
COPY requirements.txt /app/
RUN pip install --upgrade pip
RUN pip install -r requirements.txt

# Copia todo o cÃ³digo da aplicaÃ§Ã£o
COPY . /app/

ENTRYPOINT ["python", "orchestrator_subprocess.py"]
MudanÃ§as:

âœ… Remove instalaÃ§Ã£o do Google Chrome (30+ linhas)
âœ… Remove dependÃªncias do Chrome (libgbm1, libnss3, etc)
âœ… Dockerfile fica 70% menor e mais rÃ¡pido
âœ… NÃ£o importa se Ã© Debian ou Ubuntu - Chrome estÃ¡ no Grid!
4. requirements.txt (Sem mudanÃ§as)
MantÃ©m como estÃ¡:

txt
selenium==4.25.0
O selenium jÃ¡ suporta Remote WebDriver nativamente.

ğŸ“Š COMPARAÃ‡ÃƒO: ANTES vs DEPOIS
Aspecto	Antes (Chrome Local)	Depois (Selenium Grid)
InstalaÃ§Ã£o Chrome	30+ linhas no Dockerfile	âŒ NÃ£o precisa
Tamanho Imagem	~800 MB	~200 MB
Tempo Build	3-5 minutos	30 segundos
Compatibilidade	âŒ Problema com Debian	âœ… Funciona sempre
Debugging	DifÃ­cil (sem interface)	âœ… VNC na porta 7900
Escalabilidade	1 Chrome por worker	âœ… 5 sessÃµes paralelas
ManutenÃ§Ã£o	Manual (atualizar Chrome)	âœ… AutomÃ¡tica (imagem oficial)
ğŸš€ PRÃ“XIMOS PASSOS
Quando vocÃª aprovar, vou:

âœ… Modificar 
docker-compose.yml
âœ… Modificar 
crawler_full.py
 (funÃ§Ã£o make_chrome)
âœ… Simplificar 
Dockerfile
âœ… Testar localmente (se possÃ­vel)
âœ… Fazer deploy na VPS
âœ… Documentar no 
DEPLOY_TRACKING.md
Quer que eu comece a implementaÃ§Ã£o? ğŸ¯



