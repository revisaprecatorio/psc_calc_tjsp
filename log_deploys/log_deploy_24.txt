=================================================================================
LOG DE DEPLOY #24 - DESCOBERTA: PROBLEMA DE CREDENCIAIS
=================================================================================

Data: 2025-10-01 20:30:00
Servidor: srv987902.hstgr.cloud (72.60.62.124)
Status: ‚è∏Ô∏è AGUARDANDO VALIDA√á√ÉO DE CREDENCIAIS

=================================================================================
CONTEXTO
=================================================================================

Ap√≥s implementar Selenium Grid com sucesso e modificar c√≥digo para priorizar
login CPF/senha, realizamos testes manuais de autentica√ß√£o e descobrimos que
o problema N√ÉO √© t√©cnico, mas sim de CREDENCIAIS INV√ÅLIDAS.

=================================================================================
TESTES MANUAIS REALIZADOS
=================================================================================

### TESTE 1: CPF do Certificado (517.648.902-30) ###

Tentativa 1: Login com CPF/CNPJ + Senha
- URL: https://esaj.tjsp.jus.br/sajcas/login
- Aba: CPF/CNPJ
- CPF: 517.648.902-30
- Senha: 903205
- Resultado: ‚ùå "Usu√°rio ou senha inv√°lidos"

Tentativa 2: Login com Certificado Digital
- URL: https://esaj.tjsp.jus.br/sajcas/login
- Aba: Certificado digital
- Certificado: FLAVIO EDUARDO CAPPI:517648
- Senha: 903205
- Resultado: ‚ùå "Usu√°rio ou senha inv√°lidos"

Tentativa 3: Login com CPF sem formata√ß√£o
- CPF: 51764890230
- Senha: 903205
- Resultado: ‚ùå "Usu√°rio ou senha inv√°lidos"

CONCLUS√ÉO TESTE 1:
- Credenciais do certificado est√£o INCORRETAS
- CPF pode n√£o estar cadastrado no Portal e-SAJ OU
- Senha 903205 n√£o √© a senha do Portal (√© a senha do .pfx)

---

### TESTE 2: CPF Pessoal (073.019.918-51) ###

Tentativa: Login com CPF/CNPJ + Senha v√°lida
- URL: https://esaj.tjsp.jus.br/sajcas/login
- Aba: CPF/CNPJ
- CPF: 073.019.918-51
- Senha: [SENHA V√ÅLIDA]
- Resultado: ‚úÖ LOGIN BEM-SUCEDIDO!

Fluxo de Autentica√ß√£o:
1. Preencheu CPF e senha
2. Clicou em "Entrar"
3. Sistema pediu valida√ß√£o 2FA
4. C√≥digo enviado para email (per***********@gmail.com)
5. Inseriu c√≥digo: 188383
6. Redirecionado para Portal e-SAJ
7. Login confirmado: "Persival Balleste Prates"

Limita√ß√£o:
- ‚ö†Ô∏è Conta n√£o tem perfil de advogado
- ‚ö†Ô∏è N√£o consegue acessar processos judiciais
- ‚ö†Ô∏è Apenas acesso b√°sico ao Portal

CONCLUS√ÉO TESTE 2:
- Sistema de autentica√ß√£o CPF/senha FUNCIONA PERFEITAMENTE
- N√£o requer certificado digital
- Sistema tem 2FA por email (pode ser desabilitado)
- Problema √© apenas credenciais incorretas do certificado

=================================================================================
AN√ÅLISE T√âCNICA
=================================================================================

### Descoberta 1: Site Aceita CPF/Senha SEM Certificado ###

HTML da p√°gina de login mostra DUAS ABAS INDEPENDENTES:

1. Aba "CPF/CNPJ" (linkAbaCpf):
   - Campos: username, password
   - Funciona SEM certificado digital
   - Testado e confirmado funcionando

2. Aba "Certificado digital" (linkAbaCertificado):
   - Requer plugin Web Signer instalado
   - Dropdown de certificados desabilitado sem plugin
   - Popup modal: "Web Signer n√£o instalado"
   - AINDA PRECISA de senha do Portal e-SAJ

### Descoberta 2: Certificado Requer Web Signer ###

HTML mostra popup bloqueando uso de certificado:

<div id="webSignerNaoInstalado" style="display: block;">
    <p>Para utiliza√ß√£o do certificado digital no Portal e-SAJ √© necess√°rio 
       a instala√ß√£o do plug-in Web Signer...</p>
</div>

Dropdown de certificados desabilitado:
<select id="certificados" ... disabled="disabled">

CONCLUS√ÉO:
- Selenium Grid N√ÉO tem Web Signer instalado
- Certificado digital N√ÉO funciona em containers Docker
- Login CPF/senha √© a √öNICA op√ß√£o vi√°vel para automa√ß√£o

### Descoberta 3: Senha do .pfx ‚â† Senha do Portal ###

IMPORTANTE: Existem DUAS senhas diferentes:

1. Senha do certificado .pfx: 903205
   - Usada para abrir o arquivo .pfx
   - Fornecida pela Certisign
   - N√ÉO √© a senha do Portal e-SAJ

2. Senha do Portal e-SAJ: [DESCONHECIDA]
   - Cadastrada pelo usu√°rio no site
   - Usada para fazer login
   - Pode ser diferente da senha do .pfx

ERRO IDENTIFICADO:
- Est√°vamos usando senha do .pfx (903205) para login
- Devemos usar senha do Portal e-SAJ (ainda n√£o temos)

=================================================================================
MODIFICA√á√ïES NO C√ìDIGO
=================================================================================

Arquivo: crawler_full.py
Fun√ß√£o: _maybe_cas_login()
Commit: 09505e0

ANTES (linhas 252-300):
- Tentava certificado PRIMEIRO
- Se falhasse, tentava CPF/senha
- Nunca chegava a tentar CPF/senha (travava no certificado)

DEPOIS (linhas 252-308):
- Tenta CPF/senha PRIMEIRO (linhas 258-262)
- Se funcionar, retorna sucesso
- Fallback para certificado (linhas 265-306)
- Logs mais detalhados

C√≥digo modificado:

```python
def _maybe_cas_login(wait, driver, cert_subject_cn, user=None, pwd=None, payload=None):
    if "sajcas/login" not in (driver.current_url or ""):
        debug(payload, "CAS: n√£o precisou logar (j√° dentro).")
        return
    
    # MODIFICA√á√ÉO: Tenta CPF/senha PRIMEIRO (certificado requer Web Signer)
    if user and pwd:
        debug(payload, "CAS: tentando login com CPF/CNPJ‚Ä¶")
        if _cas_login_with_password(wait, driver, user, pwd):
            debug(payload, "CAS: login CPF/CNPJ OK."); return
        debug(payload, "CAS: falha no login CPF/CNPJ.")
    
    # Fallback: tenta certificado (provavelmente falhar√° sem Web Signer)
    try:
        debug(payload, "CAS: tentando aba CERTIFICADO‚Ä¶")
        # ... resto do c√≥digo de certificado ...
```

BENEF√çCIOS:
- Prioriza m√©todo que funciona (CPF/senha)
- N√£o trava tentando usar certificado
- Logs claros para debug
- Mant√©m compatibilidade com certificado (se dispon√≠vel)

=================================================================================
EVID√äNCIAS COLETADAS
=================================================================================

1. Screenshots (8 imagens):
   - Tentativa login CPF do certificado (falha)
   - Tentativa login com certificado digital (falha)
   - Login bem-sucedido com CPF pessoal
   - Valida√ß√£o 2FA por email
   - Acesso ao Portal e-SAJ confirmado

2. HTML da p√°gina de login:
   - Arquivo: erro_0223266_55_2021_8_26_0500_20251001_200332.html
   - Confirma duas abas independentes
   - Mostra popup Web Signer n√£o instalado
   - Dropdown de certificados desabilitado

3. Logs do crawler:
   - log_deploy_21.txt: Configura√ß√£o do certificado
   - log_deploy_22.txt: Investiga√ß√£o do problema
   - log_deploy_23.txt: Testes de autentica√ß√£o

=================================================================================
CONFIGURA√á√ÉO ATUAL
=================================================================================

Arquivo: /opt/crawler_tjsp/.env

# ===== CERTIFICADO DIGITAL =====
CERT_PATH=/app/certs/25424636_pf.pfx
CERT_PASSWORD=903205
CERT_SUBJECT_CN=517.648.902-30
CERT_ISSUER_CN=AC Certisign M√∫ltipla G5

# ===== AUTENTICA√á√ÉO CAS (CPF/SENHA) =====
CAS_USUARIO=51764890230
CAS_SENHA=903205  # ‚ùå INCORRETA - √â a senha do .pfx, n√£o do Portal

STATUS:
- ‚úÖ Vari√°veis configuradas no .env
- ‚úÖ docker-compose.yml l√™ as vari√°veis
- ‚úÖ Container recebe as vari√°veis
- ‚ùå Senha est√° incorreta (√© a senha do .pfx)

Valida√ß√£o:
root@srv987902:/opt/crawler_tjsp# docker compose config | grep CAS
      CAS_SENHA: "903205"
      CAS_USUARIO: "51764890230"

=================================================================================
PR√ìXIMOS PASSOS
=================================================================================

### PASSO 1: Validar Credenciais com Detentor do Certificado ###

Perguntas a fazer:

1. Cadastro no Portal:
   - CPF 517.648.902-30 est√° cadastrado no Portal e-SAJ?
   - URL: https://esaj.tjsp.jus.br/esajperfil/
   - J√° fez login alguma vez?

2. Senha do Portal:
   - Qual a senha do Portal e-SAJ?
   - ‚ö†Ô∏è N√ÉO √© a senha do certificado .pfx (903205)
   - √â a senha cadastrada no site

3. Perfil da Conta:
   - Tem perfil de advogado?
   - Tem OAB vinculada?
   - Consegue acessar processos manualmente?

4. 2FA (Autentica√ß√£o de Dois Fatores):
   - A conta tem 2FA habilitado?
   - Se sim, qual email cadastrado?
   - Pode desabilitar para testes?

5. Teste Manual:
   - Fazer login manual agora
   - URL: https://esaj.tjsp.jus.br/sajcas/login
   - Confirmar que funciona

---

### PASSO 2: Ap√≥s Obter Credenciais V√°lidas ###

1. Atualizar .env:
   ```bash
   cd /opt/crawler_tjsp
   nano .env
   
   # Atualizar com senha CORRETA do Portal
   CAS_USUARIO=51764890230
   CAS_SENHA=[SENHA_CORRETA_DO_PORTAL]
   ```

2. Testar login manual:
   - Acessar: https://esaj.tjsp.jus.br/sajcas/login
   - Usar credenciais do .env
   - Confirmar que funciona

3. Reiniciar worker:
   ```bash
   docker compose restart worker
   ```

4. Resetar job para teste:
   ```bash
   psql -h 72.60.62.124 -U admin -d n8n -c "
   UPDATE consultas_esaj SET status = FALSE WHERE id = 28;"
   ```

5. Monitorar logs:
   ```bash
   docker compose logs -f worker
   ```

6. Logs esperados (SUCESSO):
   ```
   [INFO] Conectando ao Selenium Grid: http://selenium-chrome:4444
   [INFO] ‚úÖ Conectado ao Selenium Grid com sucesso!
   CAS: tentando login com CPF/CNPJ‚Ä¶
   CAS: login CPF/CNPJ OK.
   [INFO] Processando processo 0223266-55.2021.8.26.0500
   [INFO] ‚úÖ Dados extra√≠dos com sucesso
   ```

=================================================================================
DOCUMENTA√á√ÉO CRIADA/ATUALIZADA
=================================================================================

1. DEPLOY_TRACKING.md:
   - Atualizado STATUS ATUAL
   - Adicionada entrada [15] com descoberta
   - Documentados testes manuais
   - Pr√≥ximos passos claramente definidos

2. TROUBLESHOOTING_AUTENTICACAO.md (NOVO):
   - Guia completo de autentica√ß√£o
   - M√©todos de login explicados
   - Problemas comuns e solu√ß√µes
   - Checklist de valida√ß√£o
   - Testes manuais passo-a-passo
   - Perguntas para detentor do certificado

3. log_deploy_24.txt (ESTE ARQUIVO):
   - Registro completo da descoberta
   - Testes manuais documentados
   - An√°lise t√©cnica detalhada
   - Pr√≥ximos passos definidos

4. CERTIFICADO_DIGITAL_SETUP.md:
   - J√° existente
   - Documenta configura√ß√£o do certificado
   - Ser√° atualizado ap√≥s resolver credenciais

=================================================================================
COMMITS REALIZADOS
=================================================================================

Commit: 09505e0
Mensagem: "fix: prioriza login CPF/senha sobre certificado digital"
Arquivos:
- crawler_full.py (modificado)
- 25424636_pf.pfx (adicionado)
- CERTIFICADO_DIGITAL_SETUP.md (adicionado)
- log_deploys/log_deploy_20.txt (adicionado)

Status: ‚úÖ Pushed para origin/main

=================================================================================
RESUMO EXECUTIVO
=================================================================================

### O QUE FUNCIONA: ###
‚úÖ Selenium Grid operacional (100%)
‚úÖ Worker conecta ao Grid sem erros
‚úÖ C√≥digo modificado para login CPF/senha
‚úÖ Sistema de autentica√ß√£o do e-SAJ testado
‚úÖ Login manual com CPF pessoal funcionou perfeitamente
‚úÖ Infraestrutura t√©cnica completa

### O QUE N√ÉO FUNCIONA: ###
‚ùå Credenciais do certificado (CPF 517.648.902-30)
‚ùå Senha 903205 √© do .pfx, n√£o do Portal
‚ùå N√£o sabemos a senha correta do Portal e-SAJ

### BLOQUEIO ATUAL: ###
‚è∏Ô∏è Aguardando valida√ß√£o com detentor do certificado
‚è∏Ô∏è Necess√°rio obter senha CORRETA do Portal e-SAJ
‚è∏Ô∏è Necess√°rio confirmar CPF est√° cadastrado
‚è∏Ô∏è Necess√°rio confirmar conta tem perfil de advogado

### QUANDO RESOLVER: ###
üöÄ Atualizar .env com credenciais corretas
üöÄ Testar login manual
üöÄ Deploy e teste automatizado
üöÄ Sistema estar√° 100% operacional

=================================================================================
ESTAT√çSTICAS DO PROJETO
=================================================================================

Total de Tentativas: 15 (incluindo esta)
- Problemas t√©cnicos resolvidos: 13
- Problema atual: Credenciais (n√£o t√©cnico)

Tempo de Investiga√ß√£o: ~15 horas
Commits Totais: 21 commits
Arquivos de Log: 24 arquivos
Documenta√ß√£o: 6 arquivos principais

Progresso:
- Infraestrutura: 100% ‚úÖ
- Selenium Grid: 100% ‚úÖ
- C√≥digo de autentica√ß√£o: 100% ‚úÖ
- Credenciais v√°lidas: 0% ‚è∏Ô∏è (aguardando)

=================================================================================
FIM DO LOG
=================================================================================

Pr√≥xima a√ß√£o: Aguardar resposta do detentor do certificado
Respons√°vel: Detentor do certificado (valida√ß√£o de credenciais)
Prazo: Indefinido (dependente de terceiros)

Quando tiver credenciais v√°lidas:
1. Atualizar .env
2. Testar manualmente
3. Deploy automatizado
4. Validar acesso aos processos
5. Sistema em produ√ß√£o! üéâ
